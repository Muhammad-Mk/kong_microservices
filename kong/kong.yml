_format_version: "3.0"
_transform: true

# =============================================================================
# SERVICES - Define upstream services (microservices)
# =============================================================================
# 
# Docker Swarm Load Balancing + Path Transformation:
# - Kong routes point to Swarm service DNS names
# - strip_path: true removes /v1 prefix
# - Service URL path adds the clean prefix back
#
# Path Transformation Example:
#   External (Kong):     /v1/auth/login
#   After strip:         /login
#   Service URL path:    /auth
#   Final (Service):     /auth/login
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Auth Service - Public endpoints (no JWT required)
  # ---------------------------------------------------------------------------
  - name: auth-service
    url: http://auth_service:5000/auth
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: auth-routes
        paths:
          - /v1/auth
        strip_path: true
        preserve_host: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS

  # ---------------------------------------------------------------------------
  # User Service - Protected endpoints (JWT required)
  # ---------------------------------------------------------------------------
  - name: user-service
    url: http://user_service:5000/users
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: user-routes
        paths:
          - /v1/users
        strip_path: true
        preserve_host: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS

  # ---------------------------------------------------------------------------
  # Trade Service - Protected endpoints (JWT required)
  # ---------------------------------------------------------------------------
  - name: trade-service
    url: http://trade_service:5000/trades
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: trade-routes
        paths:
          - /v1/trades
        strip_path: true
        preserve_host: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS

  - name: position-service
    url: http://trade_service:5000/positions
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: position-routes
        paths:
          - /v1/positions
        strip_path: true
        preserve_host: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS

  # ---------------------------------------------------------------------------
  # Notification Service - Protected endpoints (JWT required)
  # ---------------------------------------------------------------------------
  - name: notification-service
    url: http://notification_service:5000/notifications
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: notification-routes
        paths:
          - /v1/notifications
        strip_path: true
        preserve_host: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS

  - name: channel-service
    url: http://notification_service:5000/channels
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 3
    routes:
      - name: channel-routes
        paths:
          - /v1/channels
        strip_path: true
        preserve_host: false
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS

# =============================================================================
# PLUGINS - Global and route-specific plugins
# =============================================================================

plugins:
  # ---------------------------------------------------------------------------
  # Global Rate Limiting - 10 requests per second per IP
  # ---------------------------------------------------------------------------
  # NOTE: 'local' policy stores counters in-memory per Kong node.
  # For production multi-node deployments, use 'redis' policy:
  #   policy: redis
  #   redis_host: redis-host
  #   redis_port: 6379
  #   redis_password: your-redis-password
  #   redis_database: 0
  # ---------------------------------------------------------------------------
  - name: rate-limiting
    config:
      minute: 600
      second: 10
      policy: local
      fault_tolerant: true
      hide_client_headers: false
      limit_by: ip

  # ---------------------------------------------------------------------------
  # Global CORS Support
  # ---------------------------------------------------------------------------
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-Type
        - Authorization
        - X-API-Key
        - X-Requested-With
      exposed_headers:
        - X-Auth-Token
        - X-RateLimit-Limit-Minute
        - X-RateLimit-Remaining-Minute
      credentials: false
      max_age: 3600

  # ---------------------------------------------------------------------------
  # JWT Authentication for Protected Routes
  # ---------------------------------------------------------------------------
  - name: jwt
    route: user-routes
    config:
      key_claim_name: iss
      claims_to_verify:
        - exp
      run_on_preflight: false

  - name: jwt
    route: trade-routes
    config:
      key_claim_name: iss
      claims_to_verify:
        - exp
      run_on_preflight: false

  - name: jwt
    route: position-routes
    config:
      key_claim_name: iss
      claims_to_verify:
        - exp
      run_on_preflight: false

  - name: jwt
    route: notification-routes
    config:
      key_claim_name: iss
      claims_to_verify:
        - exp
      run_on_preflight: false

  - name: jwt
    route: channel-routes
    config:
      key_claim_name: iss
      claims_to_verify:
        - exp
      run_on_preflight: false

# =============================================================================
# CONSUMERS - API consumers with credentials
# =============================================================================

consumers:
  - username: kong-demo-auth
    jwt_secrets:
      - key: kong-demo-auth
        algorithm: HS256
        secret: your-super-secret-key-change-in-production

  - username: notification-api-user
    keyauth_credentials:
      - key: notification-api-key-12345
