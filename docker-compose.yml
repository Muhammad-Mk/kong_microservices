# =============================================================================
# Kong API Gateway + Microservices Demo
# =============================================================================
# 
# This docker-compose file sets up:
# - Kong API Gateway (DB-less mode) with Kong Manager OSS UI
# - 4 Flask microservices (auth, user, trade, notification)
#
# Public endpoints:
# - Kong Gateway: http://localhost:8000
# - Kong Manager UI: http://localhost:8002
#
# Kong Manager OSS is built into Kong 3.x and enabled via environment variables.
# =============================================================================

services:
  # ===========================================================================
  # Kong API Gateway with Kong Manager OSS
  # ===========================================================================
  kong:
    image: kong:3.6
    container_name: kong-gateway
    environment:
      # DB-less mode configuration
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      
      # Proxy settings
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      
      # Listen configuration
      # Proxy listens on all interfaces (public)
      KONG_PROXY_LISTEN: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
      
      # Admin API listens on all interfaces INSIDE container
      # (for Kong Manager access within docker network)
      # But we only expose it to localhost on host machine
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      
      # Kong Manager OSS UI configuration
      # This enables the built-in Kong Manager UI
      KONG_ADMIN_GUI_LISTEN: "0.0.0.0:8002"
      KONG_ADMIN_GUI_URL: "http://localhost:8002"
      # Admin API URL that Kong Manager uses (internal docker network)
      KONG_ADMIN_GUI_API_URL: "http://localhost:8001"
      
      # Performance tuning
      KONG_NGINX_WORKER_PROCESSES: "2"
      KONG_UPSTREAM_KEEPALIVE_POOL_SIZE: "60"
      
      # Logging
      KONG_LOG_LEVEL: info
      
      # Plugins to load
      KONG_PLUGINS: bundled
      
    volumes:
      - ./kong:/kong/declarative:ro
    ports:
      # Kong Gateway Proxy (public API endpoint)
      - "8000:8000"
      - "8443:8443"
      # Kong Admin API - localhost only for security
      - "127.0.0.1:8001:8001"
      # Kong Manager OSS UI (public for demo)
      - "8002:8002"
    networks:
      - kong-network
    depends_on:
      auth_service:
        condition: service_healthy
      user_service:
        condition: service_healthy
      trade_service:
        condition: service_healthy
      notification_service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ===========================================================================
  # Auth Service
  # ===========================================================================
  auth_service:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    container_name: auth-service
    environment:
      FLASK_ENV: production
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      JWT_ACCESS_TOKEN_EXPIRES: 3600
      JWT_REFRESH_TOKEN_EXPIRES: 604800
      LOG_LEVEL: INFO
    networks:
      - kong-network
    # NOTE: Port NOT exposed to host - only accessible through Kong
    expose:
      - "5000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/v1/auth/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # ===========================================================================
  # User Service
  # ===========================================================================
  user_service:
    build:
      context: ./user_service
      dockerfile: Dockerfile
    container_name: user-service
    environment:
      FLASK_ENV: production
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      LOG_LEVEL: INFO
    networks:
      - kong-network
    # NOTE: Port NOT exposed to host - only accessible through Kong
    expose:
      - "5000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/v1/users/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # ===========================================================================
  # Trade Service
  # ===========================================================================
  trade_service:
    build:
      context: ./trade_service
      dockerfile: Dockerfile
    container_name: trade-service
    environment:
      FLASK_ENV: production
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      LOG_LEVEL: INFO
    networks:
      - kong-network
    # NOTE: Port NOT exposed to host - only accessible through Kong
    expose:
      - "5000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/v1/trades/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # ===========================================================================
  # Notification Service
  # ===========================================================================
  notification_service:
    build:
      context: ./notification_service
      dockerfile: Dockerfile
    container_name: notification-service
    environment:
      FLASK_ENV: production
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      LOG_LEVEL: INFO
    networks:
      - kong-network
    # NOTE: Port NOT exposed to host - only accessible through Kong
    expose:
      - "5000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/v1/notifications/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================
networks:
  kong-network:
    driver: bridge
    name: kong-demo-network
